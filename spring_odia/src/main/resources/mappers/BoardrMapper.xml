<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.green.green.dao.BoardDAO">
	<select id="selectBoardList" resultType="kr.green.green.vo.BoardVO">
		select * from board where bd_type = #{cri.type} and bd_del = 'N' 
				and bd_title like concat('%',#{cri.search},'%') <!-- like concat(, ,)은 그냥 외워두자 -->
			order by bd_ori_num desc, bd_num asc 
			limit #{cri.pageStart}, #{cri.perPageNum}
		<!--일반게시판과 공지사항이 같은 bd공유하기 때문에 bd_type으로 구분  -->
	</select>
	<select id="selectBoard" resultType="kr.green.green.vo.BoardVO">
		select * from board where bd_num= #{bd_num} and bd_del='N'
			order by bd_num desc
			
	</select>
	<insert id='insertBoard'
			useGeneratedKeys="true"
			keyProperty="board.bd_num"
			parameterType="kr.green.green.vo.BoardVO">
		insert into
			board(
				bd_title,
				bd_contents,
				bd_me_id,
				bd_reg_date,
				bd_type,
				bd_ori_num,
				bd_del
			)
		<if test = "board.bd_ori_num == 0"><!-- 답변과 일반 게시글 구분용 -->
	 		select
				#{board.bd_title}, #{board.bd_contents}, #{board.bd_me_id},
				now(), #{board.bd_type}, ifnull(max(bd_num),0)+1,'N'
			from board;
		</if>
		<if test = "board.bd_ori_num != 0"><!-- 자동으로 추가하지 않고... -->
			values(#{board.bd_title}, #{board.bd_contents}, #{board.bd_me_id},
				now(), #{board.bd_type}, #{board.bd_ori_num},'N')
		</if>
	</insert>

	<update id="updateBoard">
		update board set
			bd_title = #{board.bd_title},
			bd_contents = #{board.bd_contents},
			bd_up_date = now()
		where bd_num = #{board.bd_num}
	</update>
 	<update id="deleteBoard">
 		update board set
 			bd_del = "Y",
 			bd_del_date = now()
 		where bd_num = #{bd_num}
 		<!-- 위 업데이트는 DAO에서 boadVO로 보냈고 이건 Integer낱개로 보내서 board.없어도됨 -->
 	</update>
 	<insert id="insertFile">
	  	insert into file(fi_ori_name, fi_name, fi_bd_num)
	  		values(#{file.fi_ori_name},#{file.fi_name},#{file.fi_bd_num})
	 </insert>
	 <select id="selectFileList" resultType="kr.green.green.vo.FileVO">
	 	select * from file where fi_bd_num = #{bd_num} and fi_del is null
	 </select>
	 <update id="deleteFile">
	 	update file set
	 		fi_del = 'Y',
	 		fi_del_date = now()
	 	where fi_num = #{file.fi_num}
	 </update>
	 <select id="selectBoardCount" resultType="int">
	 	select count(*) from board
	 	where bd_type = #{cri.type} and bd_del='N'and bd_title like concat('%',#{cri.search},'%') <!-- 검색결과 조건 추가 -->
	 </select>
	 <update id="updateViews">
	 	update board set
	 		bd_views=bd_views + 1
	 	where bd_num = #{bd_num}
	 </update>
</mapper>